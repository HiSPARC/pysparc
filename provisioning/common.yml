---
- name: Make sure hisparc user is in adm and plugdev groups
  user: name=hisparc groups=adm,sudo,plugdev append=yes
  sudo: yes

- name: Update package index
  apt: update_cache=yes
  sudo: yes

- name: Install update-notifier-common
  apt: name=screen state=present
  sudo: yes

- name: Safe-upgrade packages
  apt: upgrade=safe
  sudo: yes

- name: Check if reboot is necessary
  stat: path=/var/run/reboot-required
  register: p

# https://support.ansible.com/hc/en-us/articles/201958037-Reboot-a-server-and-wait-for-it-to-come-back
- name: Reboot if necessary after upgrade
  command: shutdown -r now "Ansible triggered a reboot"
  async: 0
  poll: 0
  ignore_errors: true
  when: p.stat.isfile is defined
  sudo: yes

- name: waiting for server to come back
  local_action: wait_for host={{ ansible_ssh_host }} state=started
                port={{ ansible_ssh_port }} delay=5

- name: Install screen
  apt: name=screen state=present
  sudo: yes

- name: Install ipython
  apt: name=ipython state=present
  sudo: yes

- name: Allow access to FTDI devices
  copy: src=99-libftdi.rules dest=/etc/udev/rules.d/99-libftdi.rules
  sudo: yes

- name: Install ACL utilities
  apt: name=acl state=present
  sudo: yes

- name: Install git
  apt: name=git state=present
  sudo: yes

- name: Install supervisor
  apt: name=supervisor state=present
  sudo: yes

- name: Configure supervisor
  copy: src=supervisord.conf dest=/etc/supervisor/supervisord.conf
  sudo: yes
  notify: restart supervisor
